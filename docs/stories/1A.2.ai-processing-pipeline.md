# Story 1A.2: AI Processing Pipeline

## Status
Draft

## Story
**As a** PM,
**I want** voice notes transcribed with construction accuracy,
**so that** I can validate the core value proposition.

## Acceptance Criteria
1. **Whisper Integration**: Single voice note transcription via OpenAI API
2. **Construction Prompting**: Basic GPT-4 prompt for construction terminology
3. **Confidence Display**: Show confidence score to user
4. **Error Handling**: Basic error messages for failed processing

## Tasks / Subtasks
- [ ] Task 1: OpenAI Integration Setup (AC: 1)
  - [ ] Configure OpenAI API client in Django backend
  - [ ] Create basic API endpoint for voice transcription
  - [ ] Implement file upload handling from Supabase storage
  - [ ] Add Whisper API call with construction-optimized settings
- [ ] Task 2: Construction-Specific AI Prompting (AC: 2)
  - [ ] Create GPT-4 prompt template for construction terminology
  - [ ] Implement data extraction from transcriptions
  - [ ] Add construction-specific vocabulary and context
  - [ ] Test prompt accuracy with Irish construction terminology
- [ ] Task 3: Confidence Scoring System (AC: 3)
  - [ ] Extract confidence scores from Whisper API response
  - [ ] Calculate composite confidence based on audio quality and terminology
  - [ ] Create confidence display component for frontend
  - [ ] Add confidence-based routing (high/medium/low confidence paths)
- [ ] Task 4: Error Handling & User Feedback (AC: 4)
  - [ ] Add comprehensive error handling for API failures
  - [ ] Create user-friendly error messages for common issues
  - [ ] Add retry mechanism for temporary failures
  - [ ] Implement processing status indicators

## Dev Notes

### OpenAI API Integration
**API Configuration:**
- Use OpenAI Whisper API for transcription
- Model: `whisper-1` (latest stable)
- Language hint: `en` (English optimized for Irish accents)
- Temperature: 0.2 for consistency
- Response format: `json` with timestamps
[Source: epic-1a-core-validation.md#ai-openai-whisper-gpt-4-only]

### Construction-Specific Prompting
**GPT-4 Prompt Template:**
```
You are transcribing construction site communications from Ireland. Focus on:
- Construction terminology (scaffolding, formwork, reinforcement, etc.)
- Irish/UK measurement units (metres, millimetres, tonnes)
- Common construction materials (concrete, steel, timber, block)
- Site safety terms and procedures
- Weather-related construction impacts
- Equipment and machinery names

Extract key information:
- Amounts/quantities mentioned
- Materials or services referenced
- Dates/deadlines mentioned
- Safety concerns or incidents
- Work completion status
```
[Source: epic-1a-core-validation.md#construction-prompting]

### File Locations
- **Backend**: `apps/processing/services/ai_service.py`
- **API Endpoints**: `apps/processing/views.py`
- **Models**: `apps/processing/models.py` (for processing records)
- **Frontend Components**: `components/ProcessingStatus.tsx`, `components/ConfidenceBadge.tsx`

### Confidence Scoring Logic
**Scoring Factors:**
- Whisper confidence score (primary)
- Audio quality indicators (no_speech_prob, etc.)
- Construction terminology recognition
- Amount/currency extraction accuracy
- Overall processing success rate

**Confidence Levels:**
- **High (85%+)**: Green badge, can proceed automatically
- **Medium (60-84%)**: Yellow badge, suggest manual review
- **Low (<60%)**: Red badge, requires manual review
[Source: epic-1a-core-validation.md#confidence-display]

### Error Handling Scenarios
**Common Errors:**
- File format not supported
- Audio quality too poor for transcription
- OpenAI API rate limits or failures
- Network connectivity issues
- File too large or too long

**User-Friendly Messages:**
- "Audio quality is too low for accurate transcription. Try recording closer to the speaker."
- "File format not supported. Please use MP3, M4A, or WAV files."
- "Processing temporarily unavailable. Please try again in a moment."

### API Response Format
```json
{
  "transcription": "...",
  "confidence_score": 87,
  "extracted_data": {
    "amounts": ["â‚¬1,250", "15 tonnes"],
    "materials": ["concrete", "rebar"],
    "dates": ["next Friday"]
  },
  "processing_time": 23.4,
  "status": "completed"
}
```

### Testing
**Validation Requirements:**
- Test with real Irish construction voice notes
- Verify >85% accuracy target for clear audio
- Test error handling with corrupted/invalid files
- Validate construction terminology extraction
- Measure processing times (<60 seconds target)

**Test Data:**
- Collect 10+ real construction voice notes for testing
- Include various Irish accents and site conditions
- Test with background noise (typical construction site audio)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-07 | 1.0 | Ultra-minimal validation story created via course correction | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after story implementation*