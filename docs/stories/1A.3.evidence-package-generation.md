# Story 1A.3: Evidence Package Generation

## Status
Draft

## Story
**As a** PM,
**I want** a professional PDF output,
**so that** I can evaluate whether it's suitable for claims submission.

## Acceptance Criteria
1. **Basic PDF Template**: Simple professional template with transcription
2. **Photo Inclusion**: Attach photos from WhatsApp input
3. **Metadata**: Timestamp and basic project information
4. **Download**: Direct PDF download link

## Tasks / Subtasks
- [ ] Task 1: PDF Generation Setup (AC: 1, 4)
  - [ ] Configure PDF library in Django backend (ReportLab or WeasyPrint)
  - [ ] Create basic professional PDF template
  - [ ] Implement PDF generation API endpoint
  - [ ] Add direct download functionality with proper headers
- [ ] Task 2: Template Design (AC: 1)
  - [ ] Design clean, professional layout for construction evidence
  - [ ] Include company header space and basic branding
  - [ ] Add structured sections for transcription content
  - [ ] Ensure printable format suitable for claims submission
- [ ] Task 3: Photo Integration (AC: 2)
  - [ ] Extract photos from WhatsApp input data
  - [ ] Integrate photos into PDF layout
  - [ ] Optimize image sizing and quality for PDF
  - [ ] Handle multiple photos with proper spacing
- [ ] Task 4: Metadata and Documentation (AC: 3)
  - [ ] Add timestamp and date information
  - [ ] Include basic project information fields
  - [ ] Add confidence score and processing information
  - [ ] Include original audio file metadata

## Dev Notes

### PDF Generation Technology
**Library Choice:**
- Use **WeasyPrint** for HTML-to-PDF generation (easier styling)
- Alternative: **ReportLab** for programmatic PDF creation
- Template approach: HTML/CSS templates for professional styling
[Source: epic-1a-core-validation.md#basic-pdf-template]

### Template Structure
**PDF Layout Sections:**
1. **Header**: Company name placeholder, date, document title
2. **Summary**: Key extracted information (amounts, dates, materials)
3. **Transcription**: Full transcription text with confidence indicators
4. **Photos**: Embedded images from WhatsApp with captions
5. **Footer**: Processing metadata, confidence scores, generated timestamp

### File Locations
- **Backend**: `apps/evidence/services/pdf_generator.py`
- **Templates**: `apps/evidence/templates/pdf/evidence_package.html`
- **CSS**: `apps/evidence/static/css/pdf_styles.css`
- **API**: `apps/evidence/views.py` for PDF generation endpoint

### Professional Styling Requirements
**Visual Standards:**
- Clean, construction industry-appropriate design
- Professional fonts (Arial, sans-serif)
- Consistent margins and spacing
- High contrast for readability
- Company logo placeholder area
- Professional color scheme (blues, grays, whites)
[Source: epic-1a-core-validation.md#pdf-output-professional]

### Photo Integration
**Image Handling:**
- Accept JPG, PNG formats from WhatsApp
- Resize images to fit PDF layout (max width: 500px)
- Maintain aspect ratio
- Add image captions with timestamp
- Handle multiple photos in grid or sequential layout
[Source: epic-1a-core-validation.md#photo-inclusion]

### Metadata Fields
**Required Information:**
- **Generated**: Current timestamp
- **Original Recording**: Date/time of voice note
- **Processing**: Confidence scores and AI model info
- **Project**: Basic project name/reference (if provided)
- **Content Summary**: Extracted amounts, materials, key points
[Source: epic-1a-core-validation.md#metadata]

### PDF Template Example Structure
```html
<!DOCTYPE html>
<html>
<head>
    <title>Construction Evidence Package</title>
    <style>
        /* Professional construction document styling */
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
        .confidence { background: #f3f4f6; padding: 10px; margin: 15px 0; }
        .photos { display: flex; flex-wrap: wrap; gap: 10px; }
        .photo { max-width: 250px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Construction Evidence Package</h1>
        <p>Generated: {{ generated_date }} | Project: {{ project_name }}</p>
    </div>
    
    <div class="summary">
        <h2>Summary</h2>
        <p><strong>Key Amounts:</strong> {{ extracted_amounts }}</p>
        <p><strong>Materials:</strong> {{ materials_mentioned }}</p>
    </div>
    
    <div class="transcription">
        <h2>Voice Note Transcription</h2>
        <div class="confidence">Confidence Score: {{ confidence_score }}%</div>
        <p>{{ full_transcription }}</p>
    </div>
    
    <div class="photos">
        <h2>Supporting Images</h2>
        {% for photo in photos %}
            <img src="{{ photo.url }}" class="photo" alt="Evidence photo {{ forloop.counter }}">
        {% endfor %}
    </div>
</body>
</html>
```

### API Response Format
```json
{
  "pdf_url": "/download/evidence/abc123.pdf",
  "filename": "evidence_package_2025_01_15.pdf",
  "generated_at": "2025-01-15T14:30:00Z",
  "file_size": "2.3MB",
  "status": "ready"
}
```

### Testing Requirements
**Validation Criteria:**
- PDF opens correctly in standard PDF viewers
- Images display properly and are readable
- Text is searchable and copyable
- Professional appearance suitable for claims
- File size reasonable for email attachment (<5MB)
- Downloads work on mobile and desktop browsers

**Test Cases:**
- Generate PDF with transcription only (no photos)
- Generate PDF with multiple photos
- Test with long transcriptions (>1000 words)
- Verify formatting with various confidence scores
- Test download on different devices/browsers

### Error Handling
**Common Issues:**
- Image processing failures
- PDF generation timeout
- Large file size issues
- Font/styling problems

**User-Friendly Messages:**
- "PDF generation in progress... This may take up to 30 seconds."
- "Some images could not be processed. PDF generated with available content."
- "Download ready! File expires in 24 hours."

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-07 | 1.0 | Ultra-minimal validation story created via course correction | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after story implementation*