# Story 1A.3: Evidence Package Generation

## Status
Draft

## Story
**As a** PM,
**I want** a professional PDF output,
**so that** I can evaluate whether it's suitable for claims submission.

## Acceptance Criteria
1. **Basic PDF Template**: Simple professional template with transcription
2. **Photo Inclusion**: Attach photos from WhatsApp input
3. **Metadata**: Timestamp and basic project information
4. **Download**: Direct PDF download link

## Tasks / Subtasks
- [ ] Task 1: PDF Generation Setup (AC: 1, 4)
  - [ ] Configure PDF library in Next.js (@react-pdf/renderer or jsPDF)
  - [ ] Create basic professional PDF template component
  - [ ] Implement PDF generation API endpoint (pages/api/evidence/generate.ts)
  - [ ] Add direct download functionality with proper headers
- [ ] Task 2: Template Design (AC: 1)
  - [ ] Design clean, professional layout for construction evidence
  - [ ] Include company header space and basic branding
  - [ ] Add structured sections for transcription content
  - [ ] Ensure printable format suitable for claims submission
- [ ] Task 3: Photo Integration (AC: 2)
  - [ ] Extract photos from WhatsApp input data
  - [ ] Integrate photos into PDF layout
  - [ ] Optimize image sizing and quality for PDF
  - [ ] Handle multiple photos with proper spacing
- [ ] Task 4: Metadata and Documentation (AC: 3)
  - [ ] Add timestamp and date information
  - [ ] Include basic project information fields
  - [ ] Add confidence score and processing information
  - [ ] Include original audio file metadata

## Dev Notes

### PDF Generation Technology (Hybrid Approach)
**Library Choice:**
- Use **@react-pdf/renderer** for React-based PDF generation
- Alternative: **jsPDF** with html2canvas for simpler HTML conversion
- Future Django: Will migrate to WeasyPrint/ReportLab
- Template approach: React components (easily convertible to Django templates)
[Source: epic-1a-core-validation.md#basic-pdf-template]

### Template Structure
**PDF Layout Sections:**
1. **Header**: Company name placeholder, date, document title
2. **Summary**: Key extracted information (amounts, dates, materials)
3. **Transcription**: Full transcription text with confidence indicators
4. **Photos**: Embedded images from WhatsApp with captions
5. **Footer**: Processing metadata, confidence scores, generated timestamp

### File Locations (Hybrid Architecture)
- **API Routes**: `pages/api/evidence/` (structured for Django migration)
  - `generate.ts` → future: `/api/evidence/generate/`
  - `download/[id].ts` → future: `/api/evidence/download/{id}/`
- **Business Logic**: `lib/services/` (portable to Django)
  - `pdf.service.ts` → future: `apps/evidence/services.py`
- **Templates**: `components/pdf/` (convertible to Django templates)
  - `EvidenceTemplate.tsx` → future: `evidence_package.html`
- **Styles**: `styles/pdf.module.css` → future: `static/css/pdf_styles.css`

### Professional Styling Requirements
**Visual Standards:**
- Clean, construction industry-appropriate design
- Professional fonts (Arial, sans-serif)
- Consistent margins and spacing
- High contrast for readability
- Company logo placeholder area
- Professional color scheme (blues, grays, whites)
[Source: epic-1a-core-validation.md#pdf-output-professional]

### Photo Integration
**Image Handling:**
- Accept JPG, PNG formats from WhatsApp
- Resize images to fit PDF layout (max width: 500px)
- Maintain aspect ratio
- Add image captions with timestamp
- Handle multiple photos in grid or sequential layout
[Source: epic-1a-core-validation.md#photo-inclusion]

### Metadata Fields
**Required Information:**
- **Generated**: Current timestamp
- **Original Recording**: Date/time of voice note
- **Processing**: Confidence scores and AI model info
- **Project**: Basic project name/reference (if provided)
- **Content Summary**: Extracted amounts, materials, key points
[Source: epic-1a-core-validation.md#metadata]

### PDF Template Example (React → Django Migration Path)
```typescript
// components/pdf/EvidenceTemplate.tsx
import { Document, Page, Text, View, Image, StyleSheet } from '@react-pdf/renderer';

// Styles structured for easy CSS conversion
const styles = StyleSheet.create({
  page: { padding: 30, fontFamily: 'Helvetica' },
  header: { borderBottom: 2, borderColor: '#2563eb', paddingBottom: 10, marginBottom: 20 },
  title: { fontSize: 24, marginBottom: 10 },
  subtitle: { fontSize: 12, color: '#666' },
  section: { margin: '10 0' },
  sectionTitle: { fontSize: 16, marginBottom: 10, fontWeight: 'bold' },
  confidence: { backgroundColor: '#f3f4f6', padding: 10, marginVertical: 15 },
  text: { fontSize: 12, lineHeight: 1.5 },
  photoGrid: { flexDirection: 'row', flexWrap: 'wrap', gap: 10 },
  photo: { width: 200, marginBottom: 10 }
});

export const EvidenceTemplate = ({ data }) => (
  <Document>
    <Page size="A4" style={styles.page}>
      {/* Header - matches Django template structure */}
      <View style={styles.header}>
        <Text style={styles.title}>Construction Evidence Package</Text>
        <Text style={styles.subtitle}>
          Generated: {data.generated_date} | Project: {data.project_name || 'N/A'}
        </Text>
      </View>
      
      {/* Summary Section */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Summary</Text>
        <Text style={styles.text}>Key Amounts: {data.extracted_amounts?.join(', ') || 'None'}</Text>
        <Text style={styles.text}>Materials: {data.materials_mentioned?.join(', ') || 'None'}</Text>
      </View>
      
      {/* Transcription Section */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Voice Note Transcription</Text>
        <View style={styles.confidence}>
          <Text>Confidence Score: {data.confidence_score}%</Text>
        </View>
        <Text style={styles.text}>{data.full_transcription}</Text>
      </View>
      
      {/* Photos Section */}
      {data.photos && data.photos.length > 0 && (
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Supporting Images</Text>
          <View style={styles.photoGrid}>
            {data.photos.map((photo, index) => (
              <Image key={index} src={photo.url} style={styles.photo} />
            ))}
          </View>
        </View>
      )}
    </Page>
  </Document>
);

// Future Django template will have same structure
// Easy to convert React components to Django template tags
```

### API Implementation (Django-Compatible)
```typescript
// pages/api/evidence/generate.ts
import { NextApiRequest, NextApiResponse } from 'next';
import { PDFService } from '@/lib/services/pdf.service';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  // Match Django REST Framework structure
  if (req.method !== 'POST') {
    return res.status(405).json({ detail: 'Method not allowed' });
  }
  
  try {
    // Service layer pattern (portable to Django)
    const pdfService = new PDFService();
    const result = await pdfService.generateEvidence({
      transcription: req.body.transcription,
      confidence_score: req.body.confidence_score,
      extracted_data: req.body.extracted_data,
      photos: req.body.photos,
      metadata: req.body.metadata
    });
    
    // Response format matches Django REST
    return res.status(200).json({
      pdf_url: result.url,
      filename: result.filename,
      generated_at: result.generated_at,
      file_size: result.file_size,
      status: 'ready'
    });
  } catch (error) {
    return res.status(500).json({
      detail: error.message,
      status: 'error'
    });
  }
}
```

### API Response Format (Django REST Compatible)
```json
{
  "pdf_url": "/api/evidence/download/abc123",
  "filename": "evidence_package_2025_01_15.pdf",
  "generated_at": "2025-01-15T14:30:00Z",
  "file_size": "2.3MB",
  "status": "ready"
}
```

### Migration Notes (Next.js → Django)
**Phase 1 (Current - Next.js):**
- React PDF components for generation
- API routes handle requests
- Supabase storage for PDFs
- Service layer contains business logic

**Phase 2 (Future - Django):**
```python
# Easy migration path already structured
# apps/evidence/views.py
class EvidenceGenerateView(APIView):
    def post(self, request):
        service = PDFService()  # Same business logic
        result = service.generate_evidence(
            transcription=request.data['transcription'],
            confidence_score=request.data['confidence_score'],
            extracted_data=request.data['extracted_data'],
            photos=request.data['photos']
        )
        return Response({
            'pdf_url': result['url'],
            'filename': result['filename'],
            'generated_at': result['generated_at'],
            'file_size': result['file_size'],
            'status': 'ready'
        })
```

### Testing Requirements
**Validation Criteria:**
- PDF opens correctly in standard PDF viewers
- Images display properly and are readable
- Text is searchable and copyable
- Professional appearance suitable for claims
- File size reasonable for email attachment (<5MB)
- Downloads work on mobile and desktop browsers

**Test Cases:**
- Generate PDF with transcription only (no photos)
- Generate PDF with multiple photos
- Test with long transcriptions (>1000 words)
- Verify formatting with various confidence scores
- Test download on different devices/browsers

### Error Handling
**Common Issues:**
- Image processing failures
- PDF generation timeout
- Large file size issues
- Font/styling problems

**User-Friendly Messages:**
- "PDF generation in progress... This may take up to 30 seconds."
- "Some images could not be processed. PDF generated with available content."
- "Download ready! File expires in 24 hours."

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-07 | 1.0 | Ultra-minimal validation story created via course correction | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after story implementation*